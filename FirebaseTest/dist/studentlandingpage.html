<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Landing Page</title>
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.19.1/firebase-app.js';
        import { getFirestore, doc, getDoc } from 'https://www.gstatic.com/firebasejs/9.19.1/firebase-firestore.js';

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyC-K6Hfx5jrTvnilwha29ceKov0PC2kII0",
            authDomain: "pre-advisingdb.firebaseapp.com",
            projectId: "pre-advisingdb",
            storageBucket: "pre-advisingdb.appspot.com",
            messagingSenderId: "879799797410",
            appId: "1:879799797410:web:9a52fbf15ce59b8bda39fb",
            measurementId: "G-MSMWJ52KBW"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Fetch student data on page load
        window.onload = async () => {
            const studentId = localStorage.getItem('studentId');
            const course = localStorage.getItem('course');

            if (studentId && course) {
                await fetchStudentData(studentId, course);
                await fetchEnrolledSubjects(course, studentId);
            } else {
                alert('No student ID found in local storage.');
                window.location.href = 'studentlogin.html'; // Redirect to login if no ID
            }
        };

        async function fetchStudentData(studentId, course) {
            try {
                const docRef = doc(db, `Students/${course}/StudentData`, studentId);
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    const studentData = docSnap.data();
                    // Display student information
                    document.getElementById('student-info').innerHTML = `
                        <h2>Welcome, ${studentData.name}</h2>
                        <p>Course: ${course}</p>
                        <p>Year Level: ${studentData.year}</p>
                        <p>Semester: ${studentData.semester}</p>
                        <p>Status: ${studentData.status}</p>
                    `;

                    // Recommend subjects based on status
                    if (studentData.status === "Regular") {
                        await recommendRegularSubjects(course, studentData.year, studentData.semester);
                    } else if (studentData.status === "Irregular") {
                        await recommendIrregularSubjects(course, studentId);
                    }
                } else {
                    console.error('No such student document!');
                }
            } catch (error) {
                console.error('Error fetching student data:', error);
            }
        }

        async function fetchEnrolledSubjects(course, studentId) {
            const enrolledSubjectsDiv = document.getElementById('enrolled-subjects');
            enrolledSubjectsDiv.innerHTML = '<h3>Enrolled Subjects:</h3>';

            const table = document.createElement('table');
            table.innerHTML = `
                <tr>
                    <th>Year</th>
                    <th>Semester</th>
                    <th>Subject Code</th>
                    <th>Subject Name</th>
                    <th>Units</th>
                    <th>Status</th>
                    <th>Indicator</th>
                </tr>
            `;

            try {
                const enrollmentDocRef = doc(db, `Enrollments/${course}/EnrollmentData`, studentId);
                const enrollmentSnap = await getDoc(enrollmentDocRef);

                if (enrollmentSnap.exists()) {
                    const enrollmentData = enrollmentSnap.data();
                    const enrolledSubject = enrollmentData.enrolledSubject || {};
                    const failedSubject = enrollmentData.failedSubject || {};

                    // Log enrollment data for debugging
                    console.log('Enrollment Data:', enrollmentData);

                    // Fetch course data to get subject names and units
                    const coursesRef = doc(db, `courses/${course}`);
                    const coursesSnap = await getDoc(coursesRef);
                    const coursesData = coursesSnap.data();
                    const subjectsData = coursesData.subjects;

                    // Create a mapping of subject codes to subject names and units
                    const subjectMap = {};
                    for (const year in subjectsData) {
                        for (const semester in subjectsData[year]) {
                            const subjectsArray = subjectsData[year][semester];
                            subjectsArray.forEach(subject => {
                                subjectMap[subject.subjectId] = {
                                    name: subject.subjectName,
                                    units: subject.units
                                };
                            });
                        }
                    }

                    // Display enrolled subjects with status indication
                    for (const year in enrolledSubject) {
                        for (const semester in enrolledSubject[year]) {
                            const subjectsArray = enrolledSubject[year][semester];
                            if (Array.isArray(subjectsArray)) {
                                subjectsArray.forEach(subjectCode => {
                                    const subjectInfo = subjectMap[subjectCode] || { name: 'Unknown Subject', units: 'N/A' };
                                    const isFailed = failedSubject[year]?.[semester]?.includes(subjectCode);
                                    
                                    const status = isFailed ? 'Failed' : 'Enrolled';
                                    const indicator = isFailed ? 'Retake' : 'N/A';

                                    const row = document.createElement('tr');
                                    row.innerHTML = `
                                        <td>${year}</td>
                                        <td>${semester}</td>
                                        <td>${subjectCode}</td>
                                        <td>${subjectInfo.name}</td>
                                        <td>${subjectInfo.units}</td>
                                        <td>${status}</td>
                                        <td>${indicator}</td>
                                    `;
                                    table.appendChild(row);
                                });
                            }
                        }
                    }
                    enrolledSubjectsDiv.appendChild(table);
                } else {
                    enrolledSubjectsDiv.innerHTML += `<p>No subjects found for this student.</p>`;
                }
            } catch (error) {
                console.error('Error fetching enrolled subjects:', error);
            }
        }

        async function recommendRegularSubjects(course, year, semester) {
            const recommendedSubjectsDiv = document.getElementById('recommended-subjects');
            recommendedSubjectsDiv.innerHTML = '<h3>Recommended Subjects for Regular Students:</h3>';

            const recommendedTable = document.createElement('table');
            recommendedTable.innerHTML = `
                <tr>
                    <th>Year</th>
                    <th>Semester</th>
                    <th>Subject Code</th>
                    <th>Subject Name</th>
                    <th>Units</th>
                    <th>Status</th>
                    <th>Indicator</th>
                </tr>
            `;

            try {
                const subjectsRef = doc(db, `courses/${course}`);
                const subjectsSnap = await getDoc(subjectsRef);
                const subjectsData = subjectsSnap.data().subjects;

                const subjects = subjectsData[year]?.[semester];

                if (subjects && subjects.length > 0) {
                    subjects.forEach(subject => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${year}</td>
                            <td>${semester}</td>
                            <td>${subject.subjectId}</td>
                            <td>${subject.subjectName}</td>
                            <td>${subject.units}</td>
                            <td>Available</td>
                            <td>N/A</td>
                        `;
                        recommendedTable.appendChild(row);
                    });
                    recommendedSubjectsDiv.appendChild(recommendedTable);
                } else {
                    recommendedSubjectsDiv.innerHTML += `<p>No subjects available for recommendation.</p>`;
                }
            } catch (error) {
                console.error('Error fetching recommended subjects for regular students:', error);
            }
        }

        async function recommendIrregularSubjects(course, studentId) {
            const recommendedSubjectsDiv = document.getElementById('recommended-subjects');
            recommendedSubjectsDiv.innerHTML = '<h3>Recommended Subjects for Irregular Students:</h3>';

            // Create table
            const recommendedTable = document.createElement('table');
            recommendedTable.innerHTML = `
                <tr>
                    <th>Year</th>
                    <th>Semester</th>
                    <th>Subject Code</th>
                    <th>Subject Name</th>
                    <th>Units</th>
                </tr>
            `;

            try {
                const studentDocRef = doc(db, `Students/${course}/StudentData`, studentId);
                const studentSnap = await getDoc(studentDocRef);

                if (studentSnap.exists()) {
                    const studentData = studentSnap.data();
                    const semester = studentData.semester;
                    const year = studentData.year;

                    const failedSubjects = [];

                    // Fetch failed subjects
                    const enrollmentDocRef = doc(db, `Enrollments/${course}/EnrollmentData`, studentId);
                    const enrollmentSnap = await getDoc(enrollmentDocRef);

                    if (enrollmentSnap.exists()) {
                        const enrollmentData = enrollmentSnap.data();
                        if (enrollmentData.failedSubject) {
                            for (const year in enrollmentData.failedSubject) {
                                for (const sem in enrollmentData.failedSubject[year]) {
                                    if (Array.isArray(enrollmentData.failedSubject[year][sem])) {
                                        failedSubjects.push(...enrollmentData.failedSubject[year][sem]);
                                    }
                                }
                            }
                        }
                    }

                    const recommendedSubjects = [];
                    const subjectsRef = doc(db, `courses/${course}`);
                    const subjectsSnap = await getDoc(subjectsRef);
                    const subjectsData = subjectsSnap.data().subjects;

                    // Recommendation logic for irregular students
                    if (semester === 1) {
                        // Handle recommendations for 1st semester
                        failedSubjects.forEach(failedSubject => {
                            const subject = subjectsData[year - 1]?.[2]?.find(sub => sub.subjectId === failedSubject); // Retake failed subjects from 2nd sem of previous year
                            if (subject) {
                                recommendedSubjects.push({
                                    ...subject,
                                    year: year - 1,
                                    semester: 2
                                });
                            }
                        });

                        // Add 1st semester subjects of the current year
                        subjectsData[year]?.[1]?.forEach(subject => {
                            if (!failedSubjects.includes(subject.subjectId)) {
                                recommendedSubjects.push({
                                    ...subject,
                                    year,
                                    semester: 1
                                });
                            }
                        });
                    } else if (semester === 2) {
                        // Handle recommendations for 2nd semester
                        failedSubjects.forEach(failedSubject => {
                            const subject = subjectsData[year]?.[1]?.find(sub => sub.subjectId === failedSubject); // Retake failed subjects from 1st sem of current year
                            if (subject) {
                                recommendedSubjects.push({
                                    ...subject,
                                    year,
                                    semester: 1
                                });
                            }
                        });

                        // Add 2nd semester subjects of the current year
                        subjectsData[year]?.[2]?.forEach(subject => {
                            if (!failedSubjects.includes(subject.subjectId)) {
                                recommendedSubjects.push({
                                    ...subject,
                                    year,
                                    semester: 2
                                });
                            }
                        });
                    }

                    if (recommendedSubjects.length > 0) {
                        recommendedSubjects.forEach(subject => {
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td>${subject.year}</td>
                                <td>${subject.semester}</td>
                                <td>${subject.subjectId}</td>
                                <td>${subject.subjectName}</td>
                                <td>${subject.units}</td>
                            `;
                            recommendedTable.appendChild(row);
                        });
                        recommendedSubjectsDiv.appendChild(recommendedTable);
                    } else {
                        recommendedSubjectsDiv.innerHTML += `<p>No subjects available for recommendation.</p>`;
                    }
                }
            } catch (error) {
                console.error('Error fetching recommended subjects for irregular students:', error);
            }
        }
    </script>
</head>
<body>
    <div id="student-info"></div>
    <div id="enrolled-subjects"></div>
    <div id="recommended-subjects"></div>
</body>
</html>
