<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pre-Advising Test</title>
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.19.1/firebase-app.js';
        import { getFirestore, collection, getDocs, doc, getDoc } from 'https://www.gstatic.com/firebasejs/9.19.1/firebase-firestore.js';

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyC-K6Hfx5jrTvnilwha29ceKov0PC2kII0",
            authDomain: "pre-advisingdb.firebaseapp.com",
            projectId: "pre-advisingdb",
            storageBucket: "pre-advisingdb.appspot.com",
            messagingSenderId: "879799797410",
            appId: "1:879799797410:web:9a52fbf15ce59b8bda39fb",
            measurementId: "G-MSMWJ52KBW"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Function to fetch students for the dropdown
        async function populateStudentDropdown() {
            const studentSelect = document.getElementById('student-select');
            const coursesColRef = collection(db, 'Students');
            const coursesSnapshot = await getDocs(coursesColRef);

            coursesSnapshot.forEach(courseDoc => {
                const courseId = courseDoc.id;
                const studentDataArray = courseDoc.data().StudentData;

                // Ensure StudentData exists and is an array
                if (Array.isArray(studentDataArray)) {
                    studentDataArray.forEach(student => {
                        const option = document.createElement('option');
                        option.value = student.studentId; // Student ID
                        option.textContent = `${student.name} (${courseId})`; // Student name and course
                        studentSelect.appendChild(option);
                    });
                }
            });
        }

        // Fetch courses and eligible subjects for the selected student
        document.getElementById('student-select').addEventListener('change', async () => {
            const studentId = document.getElementById('student-select').value;

            // Fetch student's data
            const studentDocRef = doc(db, `Students/${courseId}/StudentData`, studentId);
            const studentSnapshot = await getDoc(studentDocRef);
            
            if (studentSnapshot.exists()) {
                const studentData = studentSnapshot.data();
                const enrolledSubjects = studentData.enrolledSubjects || [];
                const failedSubjects = studentData.failedSubjects || [];
                const year = studentData.year;
                const semester = studentData.semester;

                // Display eligible courses based on the student's enrollment status
                displayEligibleCourses(year, semester, enrolledSubjects, failedSubjects);
            }
        });

        // Fetch courses based on year and semester
        async function fetchCourses(year, semester) {
            const coursesColRef = collection(db, 'Courses');
            const coursesSnapshot = await getDocs(coursesColRef);
            const eligibleCourses = [];

            coursesSnapshot.forEach(courseDoc => {
                const courseData = courseDoc.data();
                const courseYear = courseData.year; // Assuming the year field is available
                const courseSemester = courseData.semester; // Assuming the semester field is available

                // Check if the course matches the year and semester
                if (courseYear === year && courseSemester === semester) {
                    eligibleCourses.push(courseData);
                }
            });

            return eligibleCourses;
        }

        // Display eligible courses logic
        async function displayEligibleCourses(year, semester, enrolledSubjects, failedSubjects) {
            const eligibleCoursesDiv = document.getElementById('eligible-courses');
            eligibleCoursesDiv.innerHTML = ''; // Clear previous results

            // Fetch eligible courses
            const eligibleCourses = await fetchCourses(year, semester);

            // Display eligible courses
            eligibleCourses.forEach(course => {
                const courseDiv = document.createElement('div');
                courseDiv.textContent = `Course: ${course.name} (Units: ${course.units})`; // Assuming name and units fields exist
                eligibleCoursesDiv.appendChild(courseDiv);
            });

            // Display enrolled subjects
            const enrolledDiv = document.createElement('div');
            enrolledDiv.innerHTML = `<strong>Enrolled Subjects:</strong> ${enrolledSubjects.join(', ') || 'None'}`;
            eligibleCoursesDiv.appendChild(enrolledDiv);

            // Display failed subjects
            const failedDiv = document.createElement('div');
            failedDiv.innerHTML = `<strong>Failed Subjects:</strong> ${failedSubjects.join(', ') || 'None'}`;
            eligibleCoursesDiv.appendChild(failedDiv);
        }

        // Populate student dropdown on page load
        window.onload = populateStudentDropdown;
    </script>
</head>
<body>
    <h1>Pre-Advising Test</h1>
    
    <label for="student-select">Select Student:</label>
    <select id="student-select">
        <option value="">-- Select a Student --</option>
    </select>

    <div id="eligible-courses">
        <!-- This is where the eligible courses will be displayed -->
    </div>
</body>
</html>
