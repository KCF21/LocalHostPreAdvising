<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Pre-Advising - 2nd year</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f4f4f4;
        }
        h1 {
            color: #333;
        }
        input, select, button {
            margin: 10px 0;
            font-size: 16px;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            cursor: pointer;
        }
        button:hover {
            background-color: #0056b3;
        }
        #pre-advising-search-results {
            list-style: none;
            margin: 0;
            padding: 0;
            border: 1px solid #ccc;
            max-height: 150px;
            overflow-y: auto;
            display: none;
            position: absolute;
            z-index: 1;
            background: white;
            width: calc(100% - 2px);
        }
        #pre-advising-search-results li {
            padding: 10px;
            border-bottom: 1px solid #ddd;
            cursor: pointer;
        }
        #pre-advising-search-results li:hover {
            background-color: #f1f1f1;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            border: 1px solid #ccc;
            padding: 10px;
            text-align: left;
        }
        /* Ensure table layout allows full control over column width */
#pre-advising-curriculum-table {
  width: 100%;
  table-layout: fixed;
}

/* Center and style the year header */
.year-header {
  text-align: center;
  font-weight: bold;
  background-color: #8362db; /* Optional: gives a background to the year header */
  padding: 10px;
  font-size: 1.2em;
  border: 1px solid #ccc; /* Adds border for clarity */
  width: 100%; /* Ensure the header spans the full width */
}

/* Ensure the other table headers (like Semester) are also centered */
th {
  text-align: center;
  padding: 8px;
  border: 1px solid #ccc;
}

/* Style the table rows */
td {
  padding: 8px;
  text-align: center;
  border: 1px solid #535252;
}

    </style>
    <script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-firestore.js"></script>
</head>
<body>
    <h1>Pre-Advising Module 2nd year</h1>

    <!-- Academic Year and Semester Selection -->
    <div>
        <label for="academic-year">Academic Year:</label>
        <select id="academic-year">
            <!-- Options will be dynamically added -->
        </select>

        <label for="semester">Semester:</label>
        <select id="semester">
            <option value="1">1st Semester</option>
            <option value="2">2nd Semester</option>
            <option value="3">Summer</option>
        </select>
    </div>

    <!-- Search Bar -->
    <div>
        <input 
            type="text" 
            id="pre-advising-student-search" 
            placeholder="Search for a student..." 
        />
        <ul id="pre-advising-search-results"></ul>
    </div>

    <!-- Student Info Section -->
    <div id="student-info-container">
        <div id="student-info-form">
            <h3>Student Information</h3>
            <div id="student-info-basic">
                <!-- Basic Info dynamically populated -->
            </div>
            <h3>Curriculum Information</h3>
            <div id="student-info-curriculum">
                <!-- Curriculum Info dynamically populated -->
            </div>
            <h3>Subjects Overview</h3>
            <div id="student-info-subjects">
                <!-- Subjects Overview dynamically populated -->
            </div>
        </div>
    </div>
    
    
    <style>
    /* Main container */
#student-info-container {
    display: flex;
    justify-content: center;
    align-items: flex-start;
    width: 100%;
    margin-top: 20px;
}

/* Form container */
#student-info-form {
    width: 100%;
    background-color: #ffffff;
    padding: 20px;
    border: 1px solid #ddd;
    border-radius: 8px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}

/* Section headers */
#student-info-form h3 {
    margin-bottom: 15px;
    font-size: 18px;
    color: #000000;
    border-bottom: 1px solid #ddd;
    padding-bottom: 5px;
}

/* Content sections */
#student-info-basic, #student-info-curriculum {
    margin-bottom: 20px;
}

#student-info-basic div, #student-info-curriculum div {
    display: flex;
    justify-content: space-between;
    margin-bottom: 10px;
}

#student-info-basic .label, #student-info-curriculum .label {
    font-weight: bold;
    color: #555;
    width: 40%;
}

#student-info-basic .value, #student-info-curriculum .value {
    width: 60%;
    color: #333;
    text-align: left;
}

/* Table for subjects */
#student-info-subjects table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 10px;
    background-color: #f9f9f9;
}

#student-info-subjects th, #student-info-subjects td {
    border: 1px solid #ddd;
    padding: 8px;
    text-align: center;
    font-size: 14px;
}

#student-info-subjects th {
    background-color: #f1f1f1;
    font-weight: bold;
}


    </style>
    
 <!-- Generate Subjects Button -->
 <button id="generate-subjects">Generate Subjects</button>


 <!-- Curated Subjects Table -->
 <table id="curated-subjects-table">
    <thead>
        <tr>
            <th>Subject Code</th>
            <th>Subject Name</th>
            <th>Lec Units</th>
            <th>Lab Units</th>
            <th>Total Units</th>
            <th>Prerequisites</th>
            <th>Grade</th>
            <th>Remarks</th>
            <th>Prerequisite Info</th>
            <th>Retake Option</th> <!-- New Column -->
        </tr>
    </thead>
    <tbody></tbody>
</table>
<!-- Styling For Curated Table -->
<style>
/* Add style for sections (year and semester) */
th[colspan="10"] {
    background-color: #007bff;
    color: rgb(1, 1, 1);
    font-size: 18px;
    padding: 10px;
    text-align: center;
    font-weight: bold;
}

/* Table styling */
#curated-subjects-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 20px;
}

#curated-subjects-table th,
#curated-subjects-table td {
    padding: 10px;
    text-align: left;
    border: 1px solid #ddd;
}

#curated-subjects-table th {
    background-color: #f2f2f2;
}

#curated-subjects-table tbody tr:hover {
    background-color: #f0f0f0;
}

/* Color coding based on remarks */
#curated-subjects-table .passed {
    background-color: #d4edda; /* Green */
}

#curated-subjects-table .failed {
    background-color: #f8d7da; /* Red */
}

#curated-subjects-table .retake-available {
    background-color: #fff3cd; /* Yellow */
}

/* Styling the tooltip */
.tooltip {
    color: #dc3545;
    font-size: 12px;
}

/* Add button styles if needed */
button {
    background-color: #007bff;
    color: white;
    padding: 10px 15px;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-size: 16px;
}

button:hover {
    background-color: #0056b3;
}

/* Center the year and semester headers */
.center-header {
    text-align: center;
    font-weight: bold;
    background-color: #f2f2f2; /* Optional: Add a background color */
    padding: 10px 0; /* Optional: Add padding for better spacing */
}



</style>



<!-- Button to Populate Curated Table -->
<button id="populate-curated-table-button">Populate Curated Subjects</button>


<!-- Table that shows the students their selected subjects  -->
<table id="all-subjects-table">
    <thead>
        <tr>
            <th>Code</th>
            <th>Name</th>
            <th>Lec</th>
            <th>Lab</th>
            <th>Total Units</th>
            <th>Prerequisites</th>
            <th>Status</th>
            <th>Retake</th>
        </tr>
    </thead>
    <tbody></tbody>
  </table>




  
    <!-- Curriculum Table -->  <!-- NOT USED ANYMORE -->
    <table id="pre-advising-curriculum-table">
        
        <tbody>
          <!-- Subjects will be dynamically populated here -->
        </tbody>
        <div id="buttonContainer" style="margin-top: 15px;"></div>

      </table>

      
      



      
      <div id="subjects-modal" class="modal">
        
        <div class="modal-content">
          <span class="close">&times;</span>
          <table class="modal-table">
              <thead>
                  <tr>
                      <th>Subject Code</th>
                      <th>Subject Name</th>
                      <th>Lecture</th>
                      <th>Lab</th>
                      <th>Total Units</th>
                      <th>Prerequisites</th>
                      <th>Status</th>
                      <th>Grade</th>
                  </tr>
              </thead>
              <tbody>
                  <!-- Dynamic subject rows will go here -->
              </tbody>
          </table>
      </div>


      
      
    <style>/* Basic modal styling */
      .modal {
          display: none; /* Hidden by default */
          position: fixed; 
          z-index: 1; 
          left: 0;
          top: 0;
          width: 100%;
          height: 100%;
          overflow: auto;
          background-color: rgb(0,0,0); 
          background-color: rgba(0,0,0,0.4); /* Black with opacity */
      }
      
      .modal-content {
          background-color: #fefefe;
          margin: 15% auto;
          padding: 20px;
          border: 1px solid #888;
          width: 80%;
      }
      
      .close {
          color: #aaa;
          float: right;
          font-size: 28px;
          font-weight: bold;
      }
      
      .close:hover,
      .close:focus {
          color: black;
          text-decoration: none;
          cursor: pointer;
      }
      
      .modal-table th, .modal-table td {
          padding: 10px;
          text-align: left;
      }
      </style>
   



   

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyC-K6Hfx5jrTvnilwha29ceKov0PC2kII0",
            authDomain: "pre-advisingdb.firebaseapp.com",
            projectId: "pre-advisingdb",
            storageBucket: "pre-advisingdb.appspot.com",
            messagingSenderId: "879799797410",
            appId: "1:879799797410:web:9a52fbf15ce59b8bda39fb",
            measurementId: "G-MSMWJ52KBW"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

// ELEMENTS
const academicYearDropdown = document.getElementById('academic-year');
const semesterDropdown = document.getElementById('semester');
const studentSearchInput = document.getElementById('pre-advising-student-search');
const searchResults = document.getElementById('pre-advising-search-results');
const curriculumTableBody = document.getElementById('pre-advising-curriculum-table').querySelector('tbody');
const generateSubjectsButton = document.getElementById('generate-subjects');

let selectedStudentId = null;
let selectedCurriculumCode = null;

// Populate Academic Year Dropdown (static range)
function populateAcademicYearDropdown() {
    const currentYear = new Date().getFullYear();
    const academicYears = [
        `${currentYear - 5}-${currentYear - 4}`,
        `${currentYear - 4}-${currentYear - 3}`,
        `${currentYear - 3}-${currentYear - 2}`,
        `${currentYear - 2}-${currentYear - 1}`,
        `${currentYear - 1}-${currentYear}`,
        `${currentYear}-${currentYear + 1}`,
        `${currentYear + 1}-${currentYear + 2}`,
    ];

    academicYearDropdown.innerHTML = '';  // Clear previous options
    academicYears.forEach(year => {
        const option = document.createElement('option');
        option.value = year;
        option.textContent = year;
        academicYearDropdown.appendChild(option);
    });
}

// Wait for DOM to be fully loaded before executing
document.addEventListener('DOMContentLoaded', () => {
    // Ensure the dropdown is populated as soon as the DOM is ready
    if (academicYearDropdown) {
        populateAcademicYearDropdown();
    } else {
        console.error('Academic Year Dropdown not found in the DOM');
    }
});

// Search Students
studentSearchInput.addEventListener('input', async () => {
    const query = studentSearchInput.value.trim();
    if (query.length > 0) {
        const students = await searchStudentsByName(query);
        displaySearchResults(students);
    } else {
        searchResults.innerHTML = '';
        searchResults.style.display = 'none';
    }
});

async function searchStudentsByName(query) {
    const students = [];
    const snapshot = await db.collectionGroup('StudentData').get();
    snapshot.forEach(doc => {
        const data = doc.data();
        if (data.name && data.name.toLowerCase().includes(query.toLowerCase())) {
            students.push({ id: doc.id, curriculumCode: doc.ref.parent.parent.id, ...data });
        }
    });
    return students;
}

function displaySearchResults(students) {
    searchResults.innerHTML = '';
    if (students.length > 0) {
        searchResults.style.display = 'block';
        students.forEach(student => {
            const li = document.createElement('li');
            li.textContent = student.name;
            li.dataset.id = student.id;
            li.addEventListener('click', async () => {
                selectedStudentId = student.id;
                selectedCurriculumCode = student.curriculumCode;

                console.log("Selected Student ID:", selectedStudentId);
                console.log("Selected Curriculum Code:", selectedCurriculumCode);

                // Clear previous data in the UI
                clearStudentData();

                studentSearchInput.value = student.name;
                searchResults.style.display = 'none';

                // Fetch and display the new student's data
                await fetchAndDisplayStudentInfo(student);
            });
            searchResults.appendChild(li);
        });
    } else {
        searchResults.style.display = 'none';
    }
}

function clearStudentData() {
    const basicInfoContainer = document.getElementById('student-info-basic');
    basicInfoContainer.innerHTML = '';

    const curriculumInfoContainer = document.getElementById('student-info-curriculum');
    curriculumInfoContainer.innerHTML = '';

    const subjectsInfoContainer = document.getElementById('student-info-subjects');
    if (subjectsInfoContainer) {
        subjectsInfoContainer.innerHTML = '';
    }
}

// Fetch curriculum and process subjects
async function fetchCurriculum(curriculumCode, studentId) {
    try {
        const studentDocPath = `/Students/${curriculumCode}/StudentData/${studentId}`;
        const studentDoc = await db.doc(studentDocPath).get();

        if (!studentDoc.exists) {
            console.error('Student document not found:', studentDocPath);
            return [];
        }

        const studentData = studentDoc.data();
        const curriculumData = studentData.curriculumData || {};
        const subjectsData = curriculumData.subjects || {};

        const subjects = [];

        for (const yearKey in subjectsData) {
            const yearSubjects = subjectsData[yearKey];
            for (const semesterKey in yearSubjects) {
                const semesterSubjects = yearSubjects[semesterKey];
                if (Array.isArray(semesterSubjects)) {
                    semesterSubjects.forEach(subject => {
                        const subjectDetails = {
                            subjectCode: subject.subjectId || 'N/A',
                            subjectName: subject.subjectName || 'N/A',
                            lec: subject.lec || 'N/A',
                            lab: subject.labUnit || 'N/A',
                            totalUnits: subject.totalUnits || 'N/A',
                            prerequisites: subject.prerequisites.join(", ") || 'N/A',
                            year: yearKey,
                            semester: semesterKey,
                            status: subject.remarks || 'N/A',
                            grade: subject.grade || 'N/A',
                        };

                        subjects.push(subjectDetails);
                    });
                }
            }
        }

        return subjects;
    } catch (error) {
        console.error('Error fetching curriculum:', error);
        return [];
    }
}

// Fetch and display student info on selection
async function fetchAndDisplayStudentInfo(student) {
    const basicInfoContainer = document.getElementById('student-info-basic');
    const curriculumInfoContainer = document.getElementById('student-info-curriculum');
    
    basicInfoContainer.innerHTML = '';
    curriculumInfoContainer.innerHTML = '';

    function createInfoRow(label, value) {
        const row = document.createElement('div');
        const labelDiv = document.createElement('div');
        const valueDiv = document.createElement('div');

        labelDiv.textContent = label;
        valueDiv.textContent = value || 'N/A';

        labelDiv.classList.add('label');
        valueDiv.classList.add('value');

        row.appendChild(labelDiv);
        row.appendChild(valueDiv);

        return row;
    }

    const basicInfo = [
        ['Student ID', student.id],
        ['Name', student.name],
        ['Course', student.course],
        ['Status', student.status || 'N/A'],
    ];

    basicInfo.forEach(([label, value]) => {
        basicInfoContainer.appendChild(createInfoRow(label, value));
    });

    try {
        const studentDocPath = `/Students/${student.curriculumCode}/StudentData/${student.id}`;
        const studentDoc = await db.doc(studentDocPath).get();

        if (!studentDoc.exists) {
            console.error('Student document not found:', studentDocPath);
            return;
        }

        const studentData = studentDoc.data();
        const { academicYearStart, academicYearEnd, curriculumData, year } = studentData;

        basicInfoContainer.appendChild(
            createInfoRow('Academic Year Range', `${academicYearStart} - ${academicYearEnd}`)
        );
        basicInfoContainer.appendChild(
            createInfoRow('Year', `${year === '1' ? '1st' : year === '2' ? '2nd' : '3rd'} Year`)
        );

        if (curriculumData) {
            const curriculumFields = [
                ['Curriculum Title', curriculumData.curriculumTitle],
                ['Curriculum Name', curriculumData.curriculumName],
                ['Start Year', curriculumData.curriculumStartYear],
                ['End Year', curriculumData.curriculumEndYear],
            ];

            curriculumFields.forEach(([label, value]) => {
                curriculumInfoContainer.appendChild(createInfoRow(label, value));
            });
        }
    } catch (error) {
        console.error('Error fetching student info:', error);
    }
}

// Wait for the DOM to be fully loaded before attaching event listeners
document.addEventListener('DOMContentLoaded', () => {
    const studentDropdown = document.getElementById('studentDropdown');
    const academicYearDropdown = document.getElementById('academicYearDropdown');

    if (studentDropdown && academicYearDropdown) {
        studentDropdown.addEventListener('change', () => {
            clearTableAndReset();
        });

        academicYearDropdown.addEventListener('change', () => {
            clearTableAndReset();
        });
    } else {
        console.error('Student Dropdown or Academic Year Dropdown not found in the DOM');
    }
});

function clearTableAndReset() {
    const curriculumTableBody = document.getElementById('pre-advising-curriculum-table').querySelector('tbody');
    curriculumTableBody.innerHTML = ''; // Clear existing rows
    alert("Student or Academic Year changed. Please click 'Generate Subjects' to refresh the data.");
}

// Modal Elements
const modal = document.getElementById('subjects-modal');
const modalTableBody = modal.querySelector('.modal-table tbody');

// Generate subjects based on selected academic year and semester
async function generateSubjects() {
    if (!selectedStudentId || !selectedCurriculumCode) {
        alert("Please select a student and curriculum first.");
        return;
    }

    const selectedAcademicYear = academicYearDropdown.value;

    try {
        const student = await fetchStudentDetails(selectedStudentId, selectedCurriculumCode);
        console.log("Selected Academic Year:", selectedAcademicYear);
        console.log("Student Year:", student.year); // Assuming `year` field in student document

        // Adjust the fetch logic based on the student's current year
        let previousYearSubjects = [];
        if (student.year === "2") {
            // 2nd-year students should see 1st-year subjects
            previousYearSubjects = await fetchCurriculumSubjectsForYear(selectedCurriculumCode, 1); // 1st-year subjects
        } else if (student.year === "3") {
            // 3rd-year students should see 2nd-year subjects
            previousYearSubjects = await fetchCurriculumSubjectsForYear(selectedCurriculumCode, 2); // 2nd-year subjects
        } else if (student.year === "4") {
            // 4th-year students should see 3rd-year subjects
            previousYearSubjects = await fetchCurriculumSubjectsForYear(selectedCurriculumCode, 3); // 3rd-year subjects
        }

        if (previousYearSubjects.length === 0) {
            alert("No previous year subjects found.");
            clearTableAndReset();
            return;
        }

        console.log(previousYearSubjects);

        // Populate the modal table with the previous year's subjects
        populateModalTable(previousYearSubjects);

        // Show the modal
        modal.style.display = 'block';
    } catch (error) {
        console.error('Error generating subjects:', error);
    }
}

// Function to fetch curriculum subjects for a specific year
async function fetchCurriculumSubjectsForYear(curriculumCode, year) {
    const subjects = await fetchCurriculum(curriculumCode, selectedStudentId);
    const yearSubjects = subjects.filter(subject =>
        subject.year === `${year}` && (subject.semester === "1" || subject.semester === "2")
    );
    return yearSubjects;
}

// Function to validate prerequisites for the current year subjects against the previous year's subjects
function validatePrerequisiteSubjects(currentYearSubjects, previousYearSubjects) {
    currentYearSubjects.forEach(subject => {
        // Ensure prerequisites is an array
        let prerequisites = subject.prerequisites;

        // If prerequisites is not an array, make it an array (or handle differently if needed)
        if (!Array.isArray(prerequisites)) {
            prerequisites = [prerequisites];  // Convert to array if it's not an array
        }

        prerequisites.forEach(prerequisite => {
            const prerequisiteSubject = previousYearSubjects.find(prevSubject => prevSubject.subjectId === prerequisite);
            if (prerequisiteSubject) {
                const prerequisiteStatus = prerequisiteSubject.status; // Assuming status is part of the subject
                if (prerequisiteStatus === "Failed") {
                    alert(`Prerequisite ${prerequisite} for ${subject.subjectName} failed. Please retake the previous year’s subject.`);
                }
            }
        });
    });
}


// Function to fetch student details from Firestore
async function fetchStudentDetails(studentId, curriculumCode) {
    const studentDocPath = `/Students/${curriculumCode}/StudentData/${studentId}`;
    const studentDoc = await db.doc(studentDocPath).get();

    if (!studentDoc.exists) {
        console.error('Student document not found:', studentDocPath);
        throw new Error('Student document not found');
    }

    return studentDoc.data();
}

// Populate modal table with subjects and input fields for grades
function populateModalTable(subjects) {
    modalTableBody.innerHTML = ''; // Clear existing rows

    // Remove any existing buttons to prevent duplication
    const existingSaveButton = modal.querySelector('#save-grades-prereq-button');
    if (existingSaveButton) existingSaveButton.remove();

    subjects.forEach(subject => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${subject.subjectCode}</td>
            <td>${subject.subjectName}</td>
            <td>${subject.lec}</td>
            <td>${subject.lab}</td>
            <td>${subject.totalUnits}</td>
            <td>${subject.prerequisites}</td>
            <td>${subject.status}</td>
            <td>
                <input type="text" class="grade-input" 
                       placeholder="1.00-5.00" 
                       data-subject="${subject.subjectCode}">
            </td>
        `;
        modalTableBody.appendChild(row);
    });

    // Add a single Save Grades (with pre-req validation) button below the table
    const saveWithPrereqButton = document.createElement('button');
    saveWithPrereqButton.textContent = "Save Grades (with pre-req validation)";
    saveWithPrereqButton.id = "save-grades-prereq-button";

    modal.querySelector('.modal-content').appendChild(saveWithPrereqButton);

    // Add event listener to the Save Grades (with pre-req validation) button
    saveWithPrereqButton.addEventListener('click', validateAndProcessGradesWithPrerequisites);
}



// Validate prerequisite grades
function validatePrerequisiteGrades(gradesToSave, subjectsData) {
    gradesToSave.forEach(({ subjectCode, status }) => {
        for (const year in subjectsData) {
            for (const semester in subjectsData[year]) {
                const semesterSubjects = subjectsData[year][semester];

                semesterSubjects.forEach(subject => {
                    if (subject.subjectId === subjectCode) {
                        // Normalize prerequisites to be an array
                        const prerequisites = Array.isArray(subject.prerequisites) 
                            ? subject.prerequisites 
                            : subject.prerequisites === "None" 
                                ? [] 
                                : [subject.prerequisites];

                        prerequisites.forEach(prerequisite => {
                            // Check prerequisite status
                            semesterSubjects.forEach(prereqSubject => {
                                if (prereqSubject.subjectId === prerequisite && prereqSubject.remarks === "Failed") {
                                    // Update subject remarks to indicate prerequisite issue
                                    subject.remarks = "Retake Available";
                                    console.warn(
                                        `Subject ${subject.subjectName} depends on failed prerequisite ${prereqSubject.subjectName}.`
                                    );
                                }
                            });
                        });
                    }
                });
            }
        }
    });
}


// Validate and process grades
function validateAndProcessGrades() {
    const gradeInputs = document.querySelectorAll('.grade-input');
    let valid = true;
    const gradesToSave = [];

    gradeInputs.forEach(input => {
        const gradeValue = parseFloat(input.value);
        const subjectCode = input.dataset.subject;

        if (!isValidGrade(gradeValue)) {
            valid = false;
            alert(`Invalid grade for ${subjectCode}. Please enter a value between 1.00 and 5.00.`);
            return;
        }

        const status = gradeValue >= 1.00 && gradeValue <= 3.00 ? "Passed" : "Failed";

        const row = input.closest('tr');
        row.children[6].textContent = status;
        row.style.color = status === "Passed" ? "green" : "red";

        gradesToSave.push({ subjectCode, grade: gradeValue, status });
    });

    if (valid) {
        saveGradesToDatabase(gradesToSave);
        alert("Grades successfully saved and validated!");
    }
}

async function validateAndProcessGradesWithPrerequisites() {
    const gradeInputs = document.querySelectorAll('.grade-input');
    let valid = true;
    const gradesToSave = [];
    const missedSubjects = [];

    // Loop through each grade input
    for (const input of gradeInputs) {
        const gradeValue = parseFloat(input.value);
        const subjectCode = input.dataset.subject;

        // Find the row of the subject
        const row = input.closest('tr');
        const subjectName = row.children[1].textContent; // Get subject name

        // Get the prerequisites of this subject
        const prerequisites = row.children[5].textContent; // Get prerequisites column value
        const prerequisitesArray = prerequisites === "None" ? [] : prerequisites.split(',');

        // Validate the grade
        if (!isValidGrade(gradeValue)) {
            valid = false;
            alert(`Invalid grade for ${subjectCode}. Please enter a value between 1.00 and 5.00.`);
            return;
        }

        // Check if prerequisites are met
        let prerequisiteValid = true;
        prerequisitesArray.forEach(prerequisite => {
            const prerequisiteRow = Array.from(modalTableBody.rows).find(r => r.cells[0].textContent === prerequisite.trim());
            if (prerequisiteRow) {
                const prerequisiteStatus = prerequisiteRow.cells[6].textContent; // Get status column of prerequisite subject
                if (prerequisiteStatus === "Failed") {
                    prerequisiteValid = false;
                }
            }
        });

        if (!prerequisiteValid) {
            // If prerequisite validation fails, add the subject to the missed list
            missedSubjects.push({
                subjectCode,
                grade: "N/A",
                status: "Missed (Failed Pre-req)"
            });

            // Update the row with "Missed" status and "N/A" grade
            row.children[6].textContent = "Missed (Failed Pre-req)";
            row.style.color = 'red'; // Highlight missed subject row
            row.children[7].querySelector('.grade-input').value = "N/A"; // Set grade to N/A
        } else {
            // If the prerequisite is met, proceed as normal
            const status = (gradeValue >= 1.00 && gradeValue <= 3.00) ? 'Passed' : 'Failed';
            row.children[6].textContent = status; // Update the "Status" column
            row.style.color = (status === 'Passed') ? 'green' : 'red'; // Highlight the row accordingly

            // Prepare data to be saved to the database
            gradesToSave.push({ subjectCode, grade: gradeValue, status });
        }
    }

    // If there are any missed subjects, ask the user for confirmation
    if (missedSubjects.length > 0) {
        const userConfirmed = confirm(`Some subjects could not be passed due to failed prerequisites. Do you want to mark them as "Missed" and continue?`);
        if (userConfirmed) {
            // Save the grades and remarks for all subjects, including missed ones
            saveGradesToDatabase([...gradesToSave, ...missedSubjects]); // Save both valid and missed subjects
            alert("Grades successfully saved, including missed subjects.");
        } else {
            alert("Grades not saved due to failed prerequisites.");
        }
    } else {
        // If no missed subjects, save all grades
        saveGradesToDatabase(gradesToSave);
        alert("Grades successfully saved!");
    }
}




async function saveGradesToDatabase(grades) {
    try {
        if (!selectedStudentId || !selectedCurriculumCode) {
            alert("No student selected to save grades.");
            return;
        }

        const studentDocPath = `/Students/${selectedCurriculumCode}/StudentData/${selectedStudentId}`;
        
        const studentDoc = await db.doc(studentDocPath).get();

        if (!studentDoc.exists) {
            console.error('Student document not found:', studentDocPath);
            alert("Failed to save grades. Student document not found.");
            return;
        }

        const studentData = studentDoc.data();
        const curriculumData = studentData.curriculumData || {};
        const subjectsData = curriculumData.subjects || {};

        // Update grades in the structure
        grades.forEach(({ subjectCode, grade, status }) => {
            for (const year in subjectsData) {
                for (const semester in subjectsData[year]) {
                    const semesterSubjects = subjectsData[year][semester];
                    semesterSubjects.forEach(subject => {
                        if (subject.subjectId === subjectCode) {
                            subject.grade = grade;
                            subject.remarks = status;
                        }
                    });
                }
            }
        });

        // Save updated data to Firestore
        await db.doc(studentDocPath).update({
            'curriculumData.subjects': subjectsData
        });

        console.log("Grades saved successfully to Firestore.");

        // Refresh the local subjects array
        subjects = []; // Clear existing array
        for (const year in subjectsData) {
            for (const semester in subjectsData[year]) {
                subjects = subjects.concat(subjectsData[year][semester]);
            }
        }

        console.log("Updated subjects array:", subjects);

    } catch (error) {
        console.error("Error saving grades to Firestore:", error);
        alert("Failed to save grades. Please try again.");
    }
}




// Helper: Validate grade
function isValidGrade(grade) {
    return /^[1-5](\.\d{1,2})?$/.test(grade);
}

// Close modal
modal.querySelector('.close').addEventListener('click', () => {
    modal.style.display = 'none';
});


// NUMBER 3 


// Get the curriculum data for a given curriculum code
async function getCurriculumData(curriculumCode) {
    const curriculumDoc = await db.collection('Curriculum').doc(curriculumCode).get();
    if (!curriculumDoc.exists) {
        console.error("Curriculum not found!");
        return null;
    }
    return curriculumDoc.data();
}

function getYearForSubject(subject, curriculumData) {
    for (let year in curriculumData.subjects) {
        for (let semester in curriculumData.subjects[year]) {
            const semesterSubjects = curriculumData.subjects[year][semester];
            
            // Check if subjectId exists within the semesterSubjects
            const subjectExists = semesterSubjects.some(s => s.subjectId === subject.subjectId);
            if (subjectExists) {
                return year;  // Return the year if subject is found
            }
        }
    }
    console.warn(`Subject ${subject.subjectId} is missing from all years/semesters.`);
    return null;
}

function getSemesterForSubject(subject, curriculumData) {
    for (let year in curriculumData.subjects) {
        for (let semester in curriculumData.subjects[year]) {
            const semesterSubjects = curriculumData.subjects[year][semester];
            
            // Check if subjectId exists within the semesterSubjects
            const subjectExists = semesterSubjects.some(s => s.subjectId === subject.subjectId);
            if (subjectExists) {
                return semester;  // Return the semester if subject is found
            }
        }
    }
    console.warn(`Subject ${subject.subjectId} is missing semester.`);
    return null;
}




const populateCuratedTableButton = document.getElementById('populate-curated-table-button');

populateCuratedTableButton.addEventListener('click', async () => {
    try {
        const allCurricula = await fetchAllCurricula(); // Fetch all curricula from the database
        displayCuratedSubjectsTable(allCurricula); // Pass the fetched curricula to the table function
    } catch (error) {
        console.error('Error fetching curricula or displaying curated subjects:', error);
    }
});


async function displayCuratedSubjectsTable(allCurricula) {
    console.log("Starting to display curated subjects table...");
    const curatedSubjectsTableBody = document.getElementById('curated-subjects-table').querySelector('tbody');
    curatedSubjectsTableBody.innerHTML = ''; // Clear existing rows

    const studentId = selectedStudentId;
    const curriculumCode = selectedCurriculumCode;

    if (!studentId || !curriculumCode) {
        console.error("Missing studentId or curriculumCode. Cannot fetch prerequisites.");
        return;
    }

    console.log("Fetching curriculum data for curriculumCode:", curriculumCode);
    const curriculumData = await getCurriculumData(curriculumCode);

    if (!curriculumData) {
        console.error("Curriculum data not found for the selected curriculum code.");
        return;
    }

    const groupedSubjects = {};

    console.log("Grouping subjects by year and semester...");
    for (const subject of subjects) {
        const year = getYearForSubject(subject, curriculumData);
        const semester = getSemesterForSubject(subject, curriculumData);

        if (!year || !semester) {
            console.warn(`Subject ${subject.subjectId} is missing year or semester.`);
            continue;
        }

        if (!groupedSubjects[year]) groupedSubjects[year] = {};
        if (!groupedSubjects[year][semester]) groupedSubjects[year][semester] = [];
        groupedSubjects[year][semester].push(subject);
    }

    console.log("Rendering grouped subjects...");
    for (const year in groupedSubjects) {
        const yearTitle = `${year === '1' ? '1st' : year === '2' ? '2nd' : '3rd'} Year Subjects`;

        for (const semester in groupedSubjects[year]) {
            const semesterSubjects = groupedSubjects[year][semester];
            
            if (!Array.isArray(semesterSubjects)) {
                console.error(`Expected an array of subjects for Year ${year} - Semester ${semester}, but got: `, semesterSubjects);
                continue;
            }

            const semesterTitle = `${semester === '1' ? '1st' : '2nd'} Semester`;
            const sectionHeader = document.createElement('tr');
            sectionHeader.innerHTML = `<th colspan="10" class="center-header">${yearTitle} - ${semesterTitle}</th>`;
            curatedSubjectsTableBody.appendChild(sectionHeader);

            for (const subject of semesterSubjects) {
                console.log(`Rendering subject: ${subject.subjectId}`);
                const unmetPrerequisites = await prerequisitesMet(subject, allCurricula, studentId, curriculumCode);
                console.log(`Unmet prerequisites for ${subject.subjectId}:`, unmetPrerequisites);

                const row = document.createElement('tr');
                row.style.color = subject.remarks === 'Passed' ? 'green' : subject.remarks === 'Failed' ? 'red' : 'black';

                const retakeCell = document.createElement('td');
                if (subject.remarks === 'Failed') {
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.dataset.subjectCode = subject.subjectId;

                    if (unmetPrerequisites.length > 0) {
                        checkbox.disabled = true;
                        retakeCell.textContent = `Prerequisite not met: ${unmetPrerequisites.map(p => p.prerequisite).join(', ')}`;
                    } else {
                        retakeCell.appendChild(checkbox);
                    }
                } else {
                    retakeCell.textContent = 'N/A';
                }

                row.innerHTML = `
                    <td>${subject.subjectId}</td>
                    <td>${subject.subjectName}</td>
                    <td>${subject.lec}</td>
                    <td>${subject.labUnit}</td>
                    <td>${subject.totalUnits}</td>
                    <td>${Array.isArray(subject.prerequisites) ? subject.prerequisites.join(', ') : 'None'}</td>
                    <td>${subject.grade || 'Pending'}</td>
                    <td>${subject.remarks || 'Pending'}</td>
                `;

                const crossEnrollmentCell = document.createElement('td');
                crossEnrollmentCell.textContent = unmetPrerequisites.map(p => `${p.prerequisite} (${p.availableIn})`).join('; ') || 'N/A';
                row.appendChild(crossEnrollmentCell);

                row.appendChild(retakeCell);
                curatedSubjectsTableBody.appendChild(row);
            }
        }
    }

    console.log('Curated subjects table updated with cross-enrollment information.');
}



// prereq
async function prerequisitesMet(subject, allCurricula, studentId, curriculumCode) {
    console.log("Checking prerequisites for subject:", subject?.subjectId);

    if (!subject || !Array.isArray(subject.prerequisites)) {
        console.error("Invalid subject passed to prerequisitesMet:", subject);
        return [];
    }

    const prerequisites = subject.prerequisites || [];
    const unmetPrerequisites = [];

    console.log("Subject prerequisites:", prerequisites);

    for (const prerequisite of prerequisites) {
        const cleanPrerequisite = cleanString(prerequisite);

        if (cleanPrerequisite === cleanString('None')) {
            console.log(`Skipping "None" prerequisite for subject: ${subject.subjectId}`);
            continue;
        }

        console.log(`Checking prerequisite: ${cleanPrerequisite}`);

        let foundInStudentCurriculum = false;
        let retakeAvailable = false;

        // Check in the student's current curriculum
        const studentDocPath = `/Students/${curriculumCode}/StudentData/${studentId}`;
        console.log(`Fetching student data from path: ${studentDocPath}`);
        
        const studentDocSnapshot = await db.doc(studentDocPath).get();

        if (studentDocSnapshot.exists) {
            const studentData = studentDocSnapshot.data();
            console.log("Student data fetched:", studentData);

            const studentCurriculumSubjects = studentData?.curriculumData?.subjects || {};
            console.log("Student curriculum subjects:", studentCurriculumSubjects);

            for (const year in studentCurriculumSubjects) {
                for (const semester in studentCurriculumSubjects[year]) {
                    const semesterSubjects = studentCurriculumSubjects[year][semester];
                    const prerequisiteSubject = semesterSubjects.find(sub => cleanString(sub.subjectId) === cleanPrerequisite);
                    if (prerequisiteSubject) {
                        foundInStudentCurriculum = true;
                        if (prerequisiteSubject.remarks === 'Failed') {
                            retakeAvailable = true;
                        }
                        console.log(`Found prerequisite in student curriculum: ${prerequisiteSubject}`);
                        break;
                    }
                }
                if (foundInStudentCurriculum) break;
            }
        } else {
            console.warn("Student document not found.");
        }

        if (!foundInStudentCurriculum) {
            console.log("Prerequisite not found in student curriculum. Checking cross-curriculum data...");
            let foundInOtherCurriculum = false;

            for (const [curriculumId, curriculumData] of Object.entries(allCurricula)) {
                if (curriculumId === curriculumCode) continue;

                const curriculumSubjects = Object.values(curriculumData.subjects || {}).flatMap(semesters =>
                    Object.values(semesters).flat()
                );

                if (curriculumSubjects.some(sub => cleanString(sub.subjectId) === cleanPrerequisite)) {
                    foundInOtherCurriculum = true;
                    unmetPrerequisites.push({
                        prerequisite,
                        availableIn: `Available in: ${curriculumData.curriculumName || curriculumId}`
                    });
                    console.log(`Prerequisite found in other curriculum: ${curriculumData.curriculumName || curriculumId}`);
                    break;
                }
            }

            if (!foundInOtherCurriculum) {
                unmetPrerequisites.push({
                    prerequisite,
                    availableIn: 'Not Available'
                });
                console.warn(`Prerequisite ${prerequisite} not found in any curriculum.`);
            }
        } else if (retakeAvailable) {
            unmetPrerequisites.push({
                prerequisite,
                availableIn: 'Available to retake'
            });
            console.log(`Retake available for prerequisite: ${prerequisite}`);
        }
    }

    console.log("Unmet prerequisites for subject:", unmetPrerequisites);
    return unmetPrerequisites;
}


// Clean string utility function
function cleanString(str) {
    return str ? str.replace(/\s+/g, '').toLowerCase() : '';
}



async function fetchAllCurricula() {
    try {
        const curriculaRef = firebase.firestore().collection('Curriculum');
        const curriculaSnapshot = await curriculaRef.get();
        const allCurricula = {};

        curriculaSnapshot.forEach(doc => {
            allCurricula[doc.id] = doc.data(); // Store curricula by their ID for easy access
        });

        console.log('All curricula fetched successfully:', allCurricula);
        return allCurricula;
    } catch (error) {
        console.error('Error fetching all curricula:', error);
        throw error;  // Propagate the error
    }
}


// not user for now 
function displayAllSubjectsTable(subjects) {
    const allSubjectsTableBody = document.getElementById('all-subjects-table').querySelector('tbody');
    allSubjectsTableBody.innerHTML = ''; // Clear previous data

    subjects.forEach(subject => {
        const row = document.createElement('tr');

        // Color-code rows
        row.style.color = subject.status === 'Passed' ? 'green' : 'red';

        // Add a checkbox for retaking subjects
        const retakeCell = document.createElement('td');
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.dataset.subjectCode = subject.subjectCode;
        checkbox.disabled = subject.status === 'Passed'; // Disable checkbox for passed subjects
        retakeCell.appendChild(checkbox);

        // Handle prerequisites feedback
        if (subject.status === 'Failed' && !prerequisitesMet(subject)) {
            checkbox.disabled = true; // Disable checkbox if prerequisites are not met
            const tooltip = document.createElement('span');
            tooltip.textContent = 'Prerequisite not met';
            tooltip.classList.add('tooltip');
            retakeCell.appendChild(tooltip);
        }

        // Populate table row
        row.innerHTML = `
            <td>${subject.subjectCode}</td>
            <td>${subject.subjectName}</td>
            <td>${subject.lec}</td>
            <td>${subject.lab}</td>
            <td>${subject.totalUnits}</td>
            <td>${subject.prerequisites || 'None'}</td>
            <td>${subject.status}</td>
        `;
        row.appendChild(retakeCell);

        allSubjectsTableBody.appendChild(row);
    });

    console.log("All subjects table populated.");
}

// Triggering the generate subjects action on button click
generateSubjectsButton.addEventListener('click', generateSubjects);

    </script>
</body>
</html>
