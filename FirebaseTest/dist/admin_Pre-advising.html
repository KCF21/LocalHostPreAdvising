<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Pre-Advising</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f4f4f4;
        }
        h1 {
            color: #333;
        }
        input, select, button {
            margin: 10px 0;
            font-size: 16px;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            cursor: pointer;
        }
        button:hover {
            background-color: #0056b3;
        }
        #pre-advising-search-results {
            list-style: none;
            margin: 0;
            padding: 0;
            border: 1px solid #ccc;
            max-height: 150px;
            overflow-y: auto;
            display: none;
            position: absolute;
            z-index: 1;
            background: white;
            width: calc(100% - 2px);
        }
        #pre-advising-search-results li {
            padding: 10px;
            border-bottom: 1px solid #ddd;
            cursor: pointer;
        }
        #pre-advising-search-results li:hover {
            background-color: #f1f1f1;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            border: 1px solid #ccc;
            padding: 10px;
            text-align: left;
        }
        /* Ensure table layout allows full control over column width */
#pre-advising-curriculum-table {
  width: 100%;
  table-layout: fixed;
}

/* Center and style the year header */
.year-header {
  text-align: center;
  font-weight: bold;
  background-color: #8362db; /* Optional: gives a background to the year header */
  padding: 10px;
  font-size: 1.2em;
  border: 1px solid #ccc; /* Adds border for clarity */
  width: 100%; /* Ensure the header spans the full width */
}

/* Ensure the other table headers (like Semester) are also centered */
th {
  text-align: center;
  padding: 8px;
  border: 1px solid #ccc;
}

/* Style the table rows */
td {
  padding: 8px;
  text-align: center;
  border: 1px solid #535252;
}

    </style>
    <script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-firestore.js"></script>
</head>
<body>
    <h1>Pre-Advising Module</h1>

    <!-- Academic Year and Semester Selection -->
    <div>
        <label for="academic-year">Academic Year:</label>
        <select id="academic-year">
            <!-- Options will be dynamically added -->
        </select>

        <label for="semester">Semester:</label>
        <select id="semester">
            <option value="1">1st Semester</option>
            <option value="2">2nd Semester</option>
            <option value="3">Summer</option>
        </select>
    </div>

    <!-- Search Bar -->
    <div>
        <input 
            type="text" 
            id="pre-advising-student-search" 
            placeholder="Search for a student..." 
        />
        <ul id="pre-advising-search-results"></ul>
    </div>

    <!-- Student Info Section -->
    <div id="student-info-container">
        <div id="student-info-form">
            <h3>Student Information</h3>
            <div id="student-info-basic">
                <!-- Basic Info dynamically populated -->
            </div>
            <h3>Curriculum Information</h3>
            <div id="student-info-curriculum">
                <!-- Curriculum Info dynamically populated -->
            </div>
            <h3>Subjects Overview</h3>
            <div id="student-info-subjects">
                <!-- Subjects Overview dynamically populated -->
            </div>
        </div>
    </div>
    
    
    <style>
    /* Main container */
#student-info-container {
    display: flex;
    justify-content: center;
    align-items: flex-start;
    width: 100%;
    margin-top: 20px;
}

/* Form container */
#student-info-form {
    width: 100%;
    background-color: #ffffff;
    padding: 20px;
    border: 1px solid #ddd;
    border-radius: 8px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}

/* Section headers */
#student-info-form h3 {
    margin-bottom: 15px;
    font-size: 18px;
    color: #000000;
    border-bottom: 1px solid #ddd;
    padding-bottom: 5px;
}

/* Content sections */
#student-info-basic, #student-info-curriculum {
    margin-bottom: 20px;
}

#student-info-basic div, #student-info-curriculum div {
    display: flex;
    justify-content: space-between;
    margin-bottom: 10px;
}

#student-info-basic .label, #student-info-curriculum .label {
    font-weight: bold;
    color: #555;
    width: 40%;
}

#student-info-basic .value, #student-info-curriculum .value {
    width: 60%;
    color: #333;
    text-align: left;
}

/* Table for subjects */
#student-info-subjects table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 10px;
    background-color: #f9f9f9;
}

#student-info-subjects th, #student-info-subjects td {
    border: 1px solid #ddd;
    padding: 8px;
    text-align: center;
    font-size: 14px;
}

#student-info-subjects th {
    background-color: #f1f1f1;
    font-weight: bold;
}


    </style>
    
 <!-- Generate Subjects Button -->
 <button id="generate-subjects">Generate Subjects</button>


 
    <!-- Curriculum Table -->
    <table id="pre-advising-curriculum-table">
        <thead>
          <tr>
            <th>Subject Code</th>
            <th>Subject Name</th>
            <th>Lec</th>
            <th>Lab</th>
            <th>Total Units</th>
            <th>Prerequisites</th>
            <th>Year</th>
            <th>Semester</th>
            <th>Status</th>
            <th>Grade</th>
          </tr>
        </thead>
        <tbody>
          <!-- Subjects will be dynamically populated here -->
        </tbody>
        <div id="buttonContainer" style="margin-top: 15px;"></div>

      </table>
      

   

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyC-K6Hfx5jrTvnilwha29ceKov0PC2kII0",
            authDomain: "pre-advisingdb.firebaseapp.com",
            projectId: "pre-advisingdb",
            storageBucket: "pre-advisingdb.appspot.com",
            messagingSenderId: "879799797410",
            appId: "1:879799797410:web:9a52fbf15ce59b8bda39fb",
            measurementId: "G-MSMWJ52KBW"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

// ELEMENTS
const academicYearDropdown = document.getElementById('academic-year');
const semesterDropdown = document.getElementById('semester');
const studentSearchInput = document.getElementById('pre-advising-student-search');
const searchResults = document.getElementById('pre-advising-search-results');
const curriculumTableBody = document.getElementById('pre-advising-curriculum-table').querySelector('tbody');
const generateSubjectsButton = document.getElementById('generate-subjects');

let selectedStudentId = null;
let selectedCurriculumCode = null;

// Populate Academic Year Dropdown (static range)
function populateAcademicYearDropdown() {
    const academicYearDropdown = document.getElementById('academic-year'); // Fetch dropdown
    if (!academicYearDropdown) {
        console.error('Dropdown element not found.');
        return;
    }

    const currentYear = new Date().getFullYear();
    const academicYears = [
        `${currentYear - 5}-${currentYear - 4}`,
        `${currentYear - 4}-${currentYear - 3}`,
        `${currentYear - 3}-${currentYear - 2}`,
        `${currentYear - 2}-${currentYear - 1}`,
        `${currentYear - 1}-${currentYear}`,
        `${currentYear}-${currentYear + 1}`,
        `${currentYear + 1}-${currentYear + 2}`,
    ];

    // Clear the dropdown
    academicYearDropdown.innerHTML = '';

    // Add options dynamically
    academicYears.forEach(year => {
        const option = document.createElement('option');
        option.value = year;
        option.textContent = year;
        academicYearDropdown.appendChild(option);
    });
}


// Search Students
studentSearchInput.addEventListener('input', async () => {
    const query = studentSearchInput.value.trim();
    if (query.length > 0) {
        const students = await searchStudentsByName(query);
        displaySearchResults(students);
    } else {
        searchResults.innerHTML = '';
        searchResults.style.display = 'none';
    }
});

async function searchStudentsByName(query) {
    const students = [];
    const snapshot = await db.collectionGroup('StudentData').get();
    snapshot.forEach(doc => {
        const data = doc.data();
        if (data.name && data.name.toLowerCase().includes(query.toLowerCase())) {
            students.push({ id: doc.id, curriculumCode: doc.ref.parent.parent.id, ...data });
        }
    });
    return students;
}

studentSearchInput.addEventListener('input', async () => {
  const query = studentSearchInput.value.trim();
  if (query.length > 0) {
    const students = await searchStudentsByName(query);
    displaySearchResults(students);
  } else {
    searchResults.innerHTML = '';
    searchResults.style.display = 'none';
  }
});

function displaySearchResults(students) {
  searchResults.innerHTML = '';
  if (students.length > 0) {
    searchResults.style.display = 'block';
    students.forEach(student => {
      const li = document.createElement('li');
      li.textContent = student.name;
      li.dataset.id = student.id;
      li.addEventListener('click', async () => {
        selectedStudentId = student.id;
        selectedCurriculumCode = student.curriculumCode;

        console.log("Selected Student ID:", selectedStudentId);
        console.log("Selected Curriculum Code:", selectedCurriculumCode);

        // Clear previous data in the UI
        clearStudentData();

        studentSearchInput.value = student.name;
        searchResults.style.display = 'none';

        // Fetch and display the new student's data
        await fetchAndDisplayStudentInfo(student);
      });
      searchResults.appendChild(li);
    });
  } else {
    searchResults.style.display = 'none';
  }
}



function clearStudentData() {
    // Clear basic student info
    const basicInfoContainer = document.getElementById('student-info-basic');
    basicInfoContainer.innerHTML = '';

    // Clear curriculum info
    const curriculumInfoContainer = document.getElementById('student-info-curriculum');
    curriculumInfoContainer.innerHTML = '';

    // Optionally clear subjects if you're reloading them for a new student
    const subjectsInfoContainer = document.getElementById('student-info-subjects');
    if (subjectsInfoContainer) {
        subjectsInfoContainer.innerHTML = '';
    }
}


// Fetch curriculum and process subjects
async function fetchCurriculum(curriculumCode, studentId) {
  try {
    const studentDocPath = `/Students/${curriculumCode}/StudentData/${studentId}`;
    const studentDoc = await db.doc(studentDocPath).get();

    if (!studentDoc.exists) {
      console.error('Student document not found:', studentDocPath);
      return [];
    }

    const studentData = studentDoc.data();
    const curriculumData = studentData.curriculumData || {};
    const subjectsData = curriculumData.subjects || {};

    const subjects = [];
    console.log("Subjects Data:", subjectsData);

    // Process subjects data and push them into the subjects array
for (const yearKey in subjectsData) {
  const yearSubjects = subjectsData[yearKey];
  for (const semesterKey in yearSubjects) {
    const semesterSubjects = yearSubjects[semesterKey];
    if (Array.isArray(semesterSubjects)) {
      semesterSubjects.forEach(subject => {
        // Log subject data to check what is being retrieved
        console.log("Subject:", subject);

        const subjectDetails = {
          subjectCode: subject.subjectId || 'N/A',  // Use 'subjectId' here
          subjectName: subject.subjectName || 'N/A', // Use 'subjectName' here
          lec: subject.lec || 'N/A',
          lab: subject.labUnit || 'N/A',  // Assuming you want 'labUnit' for lab
          totalUnits: subject.totalUnits || 'N/A',
          prerequisites: subject.prerequisites.join(", ") || 'N/A',  // Assuming prerequisites is an array, join them as string
          year: yearKey,
          semester: semesterKey,
          status: subject.remarks || 'N/A',  // Use 'remarks' instead of 'status'
          grade: subject.grade || 'N/A',
        };

        // Log the subjectDetails object to ensure it's populated correctly
        console.log("Subject Details:", subjectDetails);

        subjects.push(subjectDetails);
      });
    }
  }
}


    console.log("Filtered Subjects:", subjects);
    return subjects;
  } catch (error) {
    console.error('Error fetching curriculum:', error);
    return [];
  }
}


// Fetch and display student info on selection
async function fetchAndDisplayStudentInfo(student) {
    const basicInfoContainer = document.getElementById('student-info-basic');
    const curriculumInfoContainer = document.getElementById('student-info-curriculum');
    
    // Clear old data first
    basicInfoContainer.innerHTML = '';
    curriculumInfoContainer.innerHTML = '';

    function createInfoRow(label, value) {
        const row = document.createElement('div');
        const labelDiv = document.createElement('div');
        const valueDiv = document.createElement('div');

        labelDiv.textContent = label;
        valueDiv.textContent = value || 'N/A';

        labelDiv.classList.add('label');
        valueDiv.classList.add('value');

        row.appendChild(labelDiv);
        row.appendChild(valueDiv);

        return row;
    }

    // Populate basic info
    const basicInfo = [
        ['Student ID', student.id],
        ['Name', student.name],
        ['Course', student.course],
        ['Status', student.status || 'N/A'],
    ];

    basicInfo.forEach(([label, value]) => {
        basicInfoContainer.appendChild(createInfoRow(label, value));
    });

    try {
        const studentDocPath = `/Students/${student.curriculumCode}/StudentData/${student.id}`;
        const studentDoc = await db.doc(studentDocPath).get();

        if (!studentDoc.exists) {
            console.error('Student document not found:', studentDocPath);
            return;
        }

        const studentData = studentDoc.data();
        const { academicYearStart, academicYearEnd, curriculumData, year } = studentData;

        basicInfoContainer.appendChild(
            createInfoRow('Academic Year Range', `${academicYearStart} - ${academicYearEnd}`)
        );
        basicInfoContainer.appendChild(
            createInfoRow('Year', `${year === '1' ? '1st' : year === '2' ? '2nd' : '3rd'} Year`)
        );

        if (curriculumData) {
            const curriculumFields = [
                ['Curriculum Title', curriculumData.curriculumTitle],
                ['Curriculum Name', curriculumData.curriculumName],
                ['Start Year', curriculumData.curriculumStartYear],
                ['End Year', curriculumData.curriculumEndYear],
            ];

            curriculumFields.forEach(([label, value]) => {
                curriculumInfoContainer.appendChild(createInfoRow(label, value));
            });
        }

        // Check the student's year and redirect if necessary
        if (year === '1') {
            // Stay on the current page
            console.log('1st year student selected, staying on the same page.');
        } else if (year === '2') {
            // Redirect to another page for 2nd-year students
            window.location.href = 'admin_Pre-advising(2nd year).html'; // Change to your second-year page
        }
    } catch (error) {
        console.error('Error fetching student info:', error);
    }
}



// Wait for the DOM to be fully loaded before attaching event listeners
document.addEventListener('DOMContentLoaded', () => {
  // Ensure the elements exist before adding event listeners
  const studentDropdown = document.getElementById('studentDropdown');
  const academicYearDropdown = document.getElementById('academicYearDropdown');

  if (studentDropdown && academicYearDropdown) {
    // Event listener for when the student is changed
    studentDropdown.addEventListener('change', () => {
      clearTableAndReset();
    });

    // Event listener for when the academic year is changed
    academicYearDropdown.addEventListener('change', () => {
      clearTableAndReset();
    });
  } else {
    console.error('Student Dropdown or Academic Year Dropdown not found in the DOM');
  }
});

// Clear the table and reset when student or academic year changes
function clearTableAndReset() {
  const curriculumTableBody = document.getElementById('pre-advising-curriculum-table').querySelector('tbody');
  curriculumTableBody.innerHTML = ''; // Clear the existing table rows
  alert("Student or Academic Year changed. Please click 'Generate Subjects' to refresh the data.");
}


// Your existing function for populating subjects
async function generateSubjects() {
  if (!selectedStudentId || !selectedCurriculumCode) {
    alert("Please select a student and curriculum first.");
    return;
  }

  const academicYearDropdown = document.getElementById('academic-year');
  const selectedAcademicYear = academicYearDropdown.value;

  try {
    // Fetch student details
    const student = await getSelectedStudentDetails(selectedStudentId);
    console.log("Retrieved Student Details:", student);

    console.log("Selected Academic Year:", selectedAcademicYear);
    console.log("Student Academic Year Start:", student.academicYearStart);

    // Modify the condition to check if the selected academic year contains the student's start year
    if (!selectedAcademicYear.includes(student.academicYearStart)) {
      alert("No subjects found for this academic year.");
      clearTableAndReset();
      return;
    }

    // Fetch subjects
    const subjects = await fetchCurriculum(selectedCurriculumCode, selectedStudentId);
    console.log("Fetched Curriculum Subjects:", subjects);

    // Filter subjects
    const firstYearSubjects = subjects.filter(subject => 
      subject.year === "1" && (subject.semester === "1" || subject.semester === "2")
    );

    console.log("Filtered Subjects:", firstYearSubjects);

    if (firstYearSubjects.length > 0) {
      populateSubjectTable(firstYearSubjects);
      createEnrollSubjectsButton(firstYearSubjects);
    } else {
      alert("No subjects available for the selected year and semester.");
      clearTableAndReset();
    }
  } catch (error) {
    console.error("Error generating subjects:", error);
  }
}

// Assuming you have set selectedStudentId and selectedCurriculumCode from your dropdowns or other inputs
generateSubjectsButton.addEventListener('click', async () => {
    console.log("Selected Student ID:", selectedStudentId);
    console.log("Selected Curriculum Code:", selectedCurriculumCode);

    // Check if values are available
    if (!selectedStudentId || !selectedCurriculumCode) {
        alert("Please select a student and curriculum first.");
        return;
    }

    const student = await getSelectedStudentDetails(selectedStudentId);
    if (student) {
        await generateSubjects(student); // This should run only when the button is clicked
    } else {
        alert("Failed to fetch student details.");
    }
});



// Function to get the selected student details
async function getSelectedStudentDetails(studentId) {
  try {
    const studentDocPath = `/Students/${selectedCurriculumCode}/StudentData/${studentId}`;
    const studentDoc = await db.doc(studentDocPath).get();

    if (!studentDoc.exists) {
      console.error('Student document not found:', studentDocPath);
      return null;
    }

    const studentData = studentDoc.data();
    return studentData; 
  } catch (error) {
    console.error('Error fetching student details:', error);
    return null;
  }
}

function populateSubjectTable(subjects) {
  const curriculumTableBody = document.getElementById('pre-advising-curriculum-table').querySelector('tbody');
  curriculumTableBody.innerHTML = ''; // Clear existing rows

  // Group subjects by Year and Semester
  const groupedSubjects = groupSubjectsByYearAndSemester(subjects);

  // Loop through the years and semesters to create the table
  Object.keys(groupedSubjects).forEach(year => {
    // Create Year Header (with "st", "nd", "rd", "th" suffixes)
    const yearHeaderRow = document.createElement('tr');
    const yearHeaderCell = document.createElement('th');
    yearHeaderCell.colSpan = 10; // Set the span across all columns

    // Add suffix to the year (1st Year, 2nd Year, etc.)
    yearHeaderCell.textContent = getYearSuffix(year) + ' Year';
    yearHeaderCell.classList.add('year-header'); // Add a class for styling
    yearHeaderRow.appendChild(yearHeaderCell);
    curriculumTableBody.appendChild(yearHeaderRow);

    // Loop through each semester (1st and 2nd)
    ['1', '2'].forEach(semester => {
      const semesterHeaderRow = document.createElement('tr');
      const semesterHeaderCell = document.createElement('th');
      semesterHeaderCell.colSpan = 10; // Span across all columns
      semesterHeaderCell.textContent = `Semester ${semester}`;
      semesterHeaderRow.appendChild(semesterHeaderCell);
      curriculumTableBody.appendChild(semesterHeaderRow);

      // Create table rows for each subject in the semester
      const semesterSubjects = groupedSubjects[year][semester];
      if (semesterSubjects && semesterSubjects.length > 0) {
        semesterSubjects.forEach(subject => {
          const row = document.createElement('tr');

          // Subject Cells
          row.appendChild(createTableCell(subject.subjectCode));
          row.appendChild(createTableCell(subject.subjectName));
          row.appendChild(createTableCell(subject.lec));
          row.appendChild(createTableCell(subject.lab));
          row.appendChild(createTableCell(subject.totalUnits));

          // Ensure prerequisites is an array before calling .join()
          const prerequisites = Array.isArray(subject.prerequisites) ? subject.prerequisites.join(', ') : subject.prerequisites || 'N/A';
          row.appendChild(createTableCell(prerequisites));

          row.appendChild(createTableCell(subject.year));
          row.appendChild(createTableCell(subject.semester));
          row.appendChild(createTableCell(subject.status));
          row.appendChild(createTableCell(subject.grade));

          curriculumTableBody.appendChild(row);
        });
      } else {
        const emptyRow = document.createElement('tr');
        emptyRow.innerHTML = `<td colspan="10">No subjects available for Semester ${semester}</td>`;
        curriculumTableBody.appendChild(emptyRow);
      }
    });
  });
}

function createTableCell(content) {
  const cell = document.createElement('td');
  cell.textContent = content || 'N/A'; // Default to 'N/A' if content is empty
  return cell;
}

function groupSubjectsByYearAndSemester(subjects) {
  const grouped = {};

  subjects.forEach(subject => {
    const year = subject.year;
    const semester = subject.semester;

    // Initialize year object if it doesn't exist
    if (!grouped[year]) {
      grouped[year] = { 1: [], 2: [] };
    }

    // Push the subject into the appropriate year and semester
    grouped[year][semester].push(subject);
  });

  return grouped;
}

// Function to get the correct year suffix (1st, 2nd, 3rd, etc.)
function getYearSuffix(year) {
  switch (year) {
    case '1': return '1st';
    case '2': return '2nd';
    case '3': return '3rd';
    default: return `${year}th`;
  }
}



// This function will handle enrolling subjects only for the visible years and semesters
async function enrollFirstYearSubjects(curriculumCode, studentId) {
  console.log("Curriculum Code before enroll:", curriculumCode);
  console.log("Student ID before enroll:", studentId);

  if (!curriculumCode || !studentId) {
    console.error("Curriculum Code or Student ID is missing!");
    return;
  }

  const studentRef = db.collection('Students').doc(curriculumCode).collection('StudentData').doc(studentId);

  try {
    // Fetch the student document
    const studentDoc = await studentRef.get();
    
    if (!studentDoc.exists) {
      console.error('Student document does not exist!');
      return;
    }

    const studentData = studentDoc.data();
    const { curriculumData } = studentData; // Access subjects through curriculumData

    let subjectsUpdated = false;

    // Loop through the first year subjects (1st year, 1st and 2nd semesters)
    if (curriculumData.subjects[1]) {  // Year 1
      for (const semester in curriculumData.subjects[1]) {  // Semesters 1 and 2
        const subjectsArray = curriculumData.subjects[1][semester];
        
        for (let subject of subjectsArray) {
          // If the subject's remarks are "N/A", update it to "enrolled"
          if (subject.remarks === "N/A") {
            subject.remarks = "Enrolled";  
            subjectsUpdated = true;
            console.log(`Subject updated: ${subject.subjectName}`);
          }
        }
      }
    }

    // If subjects were updated, save them back to Firestore
    if (subjectsUpdated) {
      await studentRef.update({ curriculumData });
      console.log("All 1st year subjects enrolled successfully.");
    } else {
      console.log("No subjects to enroll in the 1st year.");
    }
  } catch (error) {
    console.error("Error enrolling 1st year subjects:", error);
  }
}






function createEnrollSubjectsButton(subjects) {
  const buttonContainer = document.getElementById('buttonContainer'); // Make sure this exists in your HTML
  buttonContainer.innerHTML = ""; // Clear previous buttons

  const enrollButton = document.createElement('button');
  enrollButton.textContent = "Enroll Subjects";
  enrollButton.classList.add('enroll-button'); // Optional for styling

  // Event listener to handle subject enrollment
  enrollButton.addEventListener('click', async () => {
    const curriculumCode = selectedCurriculumCode;
    const studentId = selectedStudentId;

    console.log("Curriculum Code before enroll:", curriculumCode);
    console.log("Student ID before enroll:", studentId);

    try {
      if (!curriculumCode || !studentId) {
        console.error("Curriculum Code or Student ID is missing!");
        return;
      }

      await enrollFirstYearSubjects(curriculumCode, studentId);
      alert("All subjects have been enrolled successfully.");
      subjects.forEach(subject => subject.status = "Enrolled");
      populateSubjectTable(subjects);
    } catch (error) {
      console.error("Error enrolling subjects:", error);
      alert("Failed to enroll subjects. Please try again.");
    }
  });

  buttonContainer.appendChild(enrollButton);
}


// Call function to populate the academic year dropdown initially
populateAcademicYearDropdown();

    </script>
</body>
</html>
